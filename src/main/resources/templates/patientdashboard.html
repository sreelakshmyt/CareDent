<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Patient Dashboard - CareDent</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- Minimalist & Clean Color Palette --- */
        :root {
            --caredent-primary: #005461; /* Dark Teal (Your primary color) */
            --caredent-accent: #00B7B5; /* Bright Cyan for highlights */
            --caredent-neutral: #f8f9fa; /* Light Gray Background */
            
            /* Mapped Variables for the Shining Card */
            --card-primary-bg: #005461; /* Base color for the card (Default Teal) */
            --card-secondary-bg: #00798a; /* Slightly lighter shade for gradient */
            --card-text-light: #ffffff;
            --card-accent: #ffdd57; /* Bright Yellow/Gold for highlights/shine */
            --radius-md: 10px;
        }
        .bg-caredent-primary { background-color: var(--caredent-primary) !important; }
        .text-caredent-primary { color: var(--caredent-primary) !important; }
        
        /* General button style (used for plan cards) */
        .btn-caredent { background-color: var(--caredent-accent); border-color: var(--caredent-accent); color: #fff; }
        .btn-caredent:hover { background-color: #009997; border-color: #009997; }

        /* ** NEW: ACCENT BUTTON FOR MODAL ACCEPT ** */
        /* Used for the "Accept & Continue" button when enabled */
        .btn-caredent-accent { 
            background-color: var(--caredent-accent); 
            border-color: var(--caredent-accent); 
            color: white; 
        }
        .btn-caredent-accent:hover { 
            background-color: #009997;
            border-color: #009997; 
            color: white; 
        }
        
        /* ** NEW: WHITE CLOSE BUTTON FOR DARK MODAL HEADER ** */
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Modal Content Styling for Terms and Conditions */
        .modal-body .p-3 {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* --- Custom Styles from Claims/Doctor Template for Header Consistency (Kept original structure) --- */
        .main-header {
            background: #98dfe9; /* Use white background */
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem 0; /* Adjusted padding */
            box-shadow: 0 1px 3px rgba(0, 84, 97, 0.08);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--caredent-primary);
        }
        .brand-tagline {
            font-size: 0.875rem;
            color: #666666;
            font-weight: 400;
            margin-top: 0.125rem;
        }
        .brand {
             display: flex;
             align-items: center;
             gap: 1rem;
             text-decoration: none;
        }
        .brand-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, var(--caredent-primary), #018790);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }
        
        .main-nav {
            display: flex;
            gap: 0.5rem;
            background: white;
            border: 1px solid #e0e0e0;
            padding: 0.5rem;
            border-radius: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            text-decoration: none;
            color: #666666;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.25s ease;
        }

        .nav-link:hover {
            background: #e6f2f3;
            color: var(--caredent-primary);
        }
        
        .nav-link.active {
            background: var(--caredent-primary);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-details h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #333333;
        }

        .user-details p {
            font-size: 0.875rem;
            color: #666666;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            text-decoration: none;
            color: #333333;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.25s ease;
        }

        .action-btn:hover {
            background: #e6f2f3;
            border-color: var(--caredent-accent);
            color: var(--caredent-primary);
        }
        /* --- END Custom Header Styles --- */
        
        /* --- Other existing styles for cards remain the same... --- */
        .card-minimalist {
            border-radius: 10px;
            transition: box-shadow 0.2s;
            border: 1px solid #e9ecef;
            background: white;
            height: 100%;
            max-width: 380px; 
            min-height: 200px; 
        }
        
        /* ========================================================= */
        /* --- INSURANCE CARD STYLING (The Shining Card) --- */
        /* ========================================================= */

        .insurance-card-active {
            /* Shining Effect: Subtle Gradient and Strong Box Shadow */
            background: linear-gradient(135deg, var(--card-primary-bg) 0%, var(--card-secondary-bg) 100%);
            color: var(--card-text-light);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            /* The "Shine" Effect */
            box-shadow: 0 10px 25px rgba(0, 84, 97, 0.4), 0 0 15px rgba(255, 255, 255, 0.2) inset; 
            
            max-width: 450px;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .insurance-card-active:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 84, 97, 0.5), 0 0 20px rgba(255, 255, 255, 0.3) inset;
        }

        .card-header-title {
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            opacity: 0.8;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .card-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.6rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--card-accent); /* Bright color for prominence */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .insurance-card-active strong, .insurance-card-active span {
            font-weight: 700;
            color: var(--card-text-light);
        }
        
        /* Styles for different plan tiers (Color Customization) */
        .id-card-basic {
           --card-primary-bg: #cf1919; /* Gray/Silver */
            --card-secondary-bg: #333333;
            --card-accent: #f0f0f0; /* White/Silver highlight */
        }
        .id-card-standard {
            --card-primary-bg: #cf1919; /* Gray/Silver */
            --card-secondary-bg: #333333;
            --card-accent: #f0f0f0; /* White/Silver highlight */
        }
        .id-card-premium {
            --card-primary-bg: #cf1919; /* Gray/Silver */
            --card-secondary-bg: #333333;
            --card-accent: #f0f0f0; /* White/Silver highlight */
        }
        /* End of Insurance Card Styles */
    </style>
</head>
<body>
    
    <header class="main-header">
        <div class="header-content">
            <a th:href="@{/patient/dashboard}" class="brand">
                <div class="brand-icon">
                    <i class="fas fa-tooth"></i>
                </div>
                <div>
                    <div class="brand-text">CareDent</div>
                    <div class="brand-tagline">Patient Portal</div>
                </div>
            </a>

            <nav class="main-nav">
                <a th:href="@{/patient/dashboard}" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
                <a th:href="@{/patient/profile}" class="nav-link">
                    <i class="fas fa-user"></i>
                    Profile
                </a>
                <a th:href="@{/patient/network}" class="nav-link">
                    <i class="fas fa-network-wired"></i>
                    Find a Dentist
                </a>
                <a th:href="@{/patient/claims}" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    Track Claims
                </a>
            </nav>
            
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-details">
                        <h3>Welcome, <span th:text="${patient != null ? patient.firstName : user.username}">Patient</span></h3>
                        <p>Member</p>
                    </div>
                </div>
                
                <a th:href="@{/api/auth/login_register}" class="action-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </div>
    </header>
    <header class="header-content">
    <div class="container text-center"> <h2 class="fw-bold text-caredent-primary">Your Member Dashboard</h2>
        <p class="text-muted">Manage your plans, view benefits, and access your digital ID cards.</p>
    </div>
</header>


    <main class="container my-5">
        
        <div th:if="${param.paid}" class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Enrollment Complete!</strong> Your coverage is now active.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <h3 class="mb-4 text-caredent-primary">Your Current Coverage (<span th:text="${activeEnrollments.size()}">0</span> Plans)</h3>
        
        <div th:if="${activeEnrollments.isEmpty()}" class="alert alert-warning text-center mb-5">
             You have no active plans. Scroll down to select a plan.
        </div>

        <div th:unless="${activeEnrollments.isEmpty()}" class="row mb-5">
            
            <div class="col-lg-6 mb-4 order-lg-2">
                <div class="card bg-white p-4 h-100 shadow-sm border border-3 border-caredent-primary">
                    <h5 class="fw-bold text-caredent-primary mb-3"><i class="fas fa-chart-line me-2"></i> Your Current Benefit Usage</h5>

                    <div th:with="annualMax=${activeEnrollments.get(0).dentalPlan.annualMax}, 
                                 claimsUsed=${totalClaimsPaid ?: 0.0},
                                 maxRemaining=${annualMax - claimsUsed},
                                 usagePercent=${(claimsUsed / annualMax) * 100}">
                        
                        <p class="small mb-1 fw-bold text-uppercase">Annual Maximum Usage</p>
                        <div class="d-flex justify-content-between align-items-baseline mb-2">
                            <span class="small text-muted">Used: <strong class="text-dark" th:text="'$' + ${#numbers.formatDecimal(claimsUsed, 1, 2)}"></strong></span>
                            <span class="small text-muted">Remaining: <strong class="text-success" th:text="'$' + ${#numbers.formatDecimal(maxRemaining, 1, 2)}"></strong> / $<span th:text="${#numbers.formatDecimal(annualMax, 1, 2)}"></span></span>
                        </div>
                        
                        <div class="progress mb-4" style="height: 12px;">
                            <div class="progress-bar bg-caredent-primary" role="progressbar" 
                                 th:style="'width: ' + ${usagePercent} + '%;'" 
                                 th:aria-valuenow="${usagePercent}" 
                                 aria-valuemin="0" th:aria-valuemax="${annualMax}">
                            </div>
                        </div>
                    </div>
                    
                     <div th:with="deductibleAmount=${activeEnrollments.get(0).dentalPlan.deductible},
                                 deductibleUsed=${deductibleUsed ?: 0.0},
                                 deductibleRemaining=${deductibleAmount - deductibleUsed},
                                 deductiblePercent=${(deductibleUsed / deductibleAmount) * 100}">
                                 
                        <p class="small mb-1 fw-bold text-uppercase">Deductible Status</p>
                        <div class="d-flex justify-content-between align-items-baseline mb-2">
                            <span class="small text-muted">Met: <strong class="text-dark" th:text="'$' + ${#numbers.formatDecimal(deductibleUsed, 1, 2)}"></strong></span>
                            <span class="small text-muted">Remaining: <strong class="text-danger" th:text="'$' + ${#numbers.formatDecimal(deductibleRemaining, 1, 2)}"></strong> / $<span th:text="${#numbers.formatDecimal(deductibleAmount, 1, 2)}"></span></span>
                        </div>
                        
                        <div class="progress mb-3" style="height: 12px;">
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 th:style="'width: ' + ${deductiblePercent} + '%;'" 
                                 th:aria-valuenow="${deductiblePercent}" 
                                 aria-valuemin="0" th:aria-valuemax="${deductibleAmount}">
                            </div>
                        </div>
                    </div>
                     

                    <p class="small mt-3 border-top pt-2 text-caredent-primary" th:if="${activeEnrollments.size() > 1}">
                        <i class="fas fa-info-circle me-1"></i> Summary shown for <strong th:text="${activeEnrollments.get(0).dentalPlan.name}">Primary Plan</strong>. You have <span th:text="${activeEnrollments.size() - 1}"></span> other plan(s).
                    </p>
                    <p class="small mt-3 border-top pt-2 text-caredent-primary" th:unless="${activeEnrollments.size() > 1}">
                        <i class="fas fa-info-circle me-1"></i> Data updated as of the last finalized claim.
                    </p>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4 order-lg-1">
                <div th:each="enrollment : ${activeEnrollments}" class="mb-4">
                    
                    <div th:classappend="${#strings.contains(enrollment.dentalPlan.name.toLowerCase(), 'basic') ? 'id-card-basic' : 
                                     (#strings.contains(enrollment.dentalPlan.name.toLowerCase(), 'premium') ? 'id-card-premium' : 'id-card-standard')}"
                          class="insurance-card-active">
                        
                        <div class="card-header-title fw-bold">CareDent Insurance Card</div>
                        
                        <h4 class="card-title fw-bolder mb-3" th:text="${enrollment.dentalPlan.name}"></h4>

                        <div class="row small mb-2">
                            <div class="col-6">Member: <strong th:text="${patient.firstName + ' ' + patient.lastName}"></strong></div>
                            <div class="col-6">ID: <strong th:text="'P' + ${patient.id} + 'E' + ${enrollment.id}"></strong></div>
                        </div>
                        <div class="row small mb-3">
                            <div class="col-6">Effective: <span th:text="${#temporals.format(enrollment.benefitYearStart, 'MM/dd/yyyy')}"></span></div>
                            <div class="col-6">Max: $<span th:text="${enrollment.dentalPlan.annualMax}"></span></div>
                        </div>
                        
                        <div class="d-flex justify-content-start">
                            <a th:href="@{/patient/card/download/{id}(id=${enrollment.id})}" 
                               class="btn btn-sm btn-light me-2 text-caredent-primary">
                                <i class="fas fa-file-pdf me-1"></i> Download PDF
                            </a>
                        </div>
                        
                        <div th:if="${enrollment.status == 'PENDING_CANCELLATION'}" class="mt-2 small fw-bold text-center bg-warning text-dark p-1 rounded">
                            <i class="fas fa-hourglass-half me-1"></i> Enrollment Pending Activation/Review
                        </div>

                    </div>
                </div>
            </div>

        </div>
            
        <h3 class="mb-4 text-caredent-primary">Choose Your Plan</h3>
        
        <div class="row">
            <div class="col-md-4 mb-4" th:each="plan : ${plans}">
                <div th:with="planName=${plan.name.toLowerCase()}"
                    th:classappend="${#strings.contains(planName, 'basic')} ? 'card-basic' : 
                                     (${#strings.contains(planName, 'premium')} ? 'card-premium' : 'card-standard')"
                    class="card card-minimalist shadow-sm h-100 p-2">
                    
                    <div class="card-body">
                        <h5 class="card-title fw-bold text-caredent-primary" th:text="${plan.name}"></h5>
                        <p class="card-text mb-1 small">Deductible: $<span th:text="${plan.deductible}"></span></p>
                        <p class="card-text mb-1 small">Annual Max: $<span th:text="${plan.annualMax}"></span></p>
                        <p class="card-text mb-3 fw-bold">Premium: $<span th:text="${plan.premium}"></span>/month</p>
                        
                        <div th:if="${!activeEnrollments.isEmpty()}">
                            <button class="btn btn-warning w-100 fw-bold small" disabled>
                                Already Enrolled in a Plan
                            </button>
                        </div>
                        
                        <div th:unless="${!activeEnrollments.isEmpty()}">
                            <button type="button"
                                    class="btn btn-caredent w-100 fw-bold small enroll-trigger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#termsModal"
                                    th:data-plan-id="${plan.id}"> <i class="fas fa-plus me-1"></i> Start Enrollment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-5">

        <h3 class="mb-4 text-caredent-primary">Quick Access & Resources</h3>
        <div class="row g-4 mb-5">
            <div class="col-md-3 col-sm-6">
                <a th:href="@{/patient/claims}" class="card text-center text-decoration-none card-minimalist shadow-sm p-3">
                    <div class="card-body p-0">
                        <i class="fas fa-file-invoice fa-2x text-caredent-primary mb-2"></i>
                        <h6 class="card-title text-dark small fw-bold">Track Claims</h6>
                    </div>
                </a>
            </div>
            <!-- <div class="col-md-3 col-sm-6">
                <a th:href="@{/patient/benefits}" class="card text-center text-decoration-none card-minimalist shadow-sm p-3">
                    <div class="card-body p-0">
                        <i class="fas fa-chart-line fa-2x text-caredent-primary mb-2"></i>
                        <h6 class="card-title text-dark small fw-bold">Benefit Usage</h6>
                    </div>
                </a>
            </div> -->
            <div class="col-md-3 col-sm-6">
                <a th:href="@{/patient/network}" class="card text-center text-decoration-none card-minimalist shadow-sm p-3">
                    <div class="card-body p-0">
                        <i class="fas fa-map-marker-alt fa-2x text-caredent-primary mb-2"></i>
                        <h6 class="card-title text-dark small fw-bold">Find a Dentist</h6>
                    </div>
                </a>
            </div>
            <div class="col-md-3 col-sm-6">
                <a th:href="@{/patient/profile}" class="card text-center text-decoration-none card-minimalist shadow-sm p-3">
                    <div class="card-body p-0">
                        <i class="fas fa-user-circle fa-2x text-caredent-primary mb-2"></i>
                        <h6 class="card-title text-dark small fw-bold">Manage Profile</h6>
                    </div>
                </a>
            </div>
        </div>
        
        <hr class="my-5">

        <h3 class="mb-4 text-caredent-primary">Plan History</h3>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-caredent">
                    <div class="card-header bg-caredent-primary text-white fw-bold">Current & Pending Plans Summary</div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center" th:each="enrollment : ${activeEnrollments}">
                            <span th:text="${enrollment.dentalPlan.name}">Plan Name</span>
                            <span class="badge" 
                                            th:classappend="${enrollment.status == 'ACTIVE' ? 'bg-success' : 'bg-warning text-dark'}" 
                                            th:text="${enrollment.status}">
                                            ACTIVE
                            </span>
                        </li>
                        <li th:if="${activeEnrollments.isEmpty()}" class="list-group-item text-muted">No current active plans.</li>
                    </ul>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-caredent">
                    <div class="card-header bg-caredent-primary text-white fw-bold">Cancelled & Expired Plans History</div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center" th:each="enrollment : ${historyEnrollments}">
                            <span th:text="${enrollment.dentalPlan.name}">Plan Name</span>
                            <span class="badge bg-secondary" 
                                            th:text="${enrollment.status}">
                                            CANCELLED
                            </span>
                        </li>
                        <li th:if="${historyEnrollments.isEmpty()}" class="list-group-item text-muted">No past plans recorded.</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <hr class="my-5">

        <div class="content-section">
            <div class="row justify-content-center">
                <div class="col-md-10 text-center">
                    <h4 class="text-caredent-primary mb-3">Our Commitment: Advanced Dental Insurance</h4>
                    <p class="text-muted lead small">
                        CareDent is a role-based insurance management platform that simulates real U.S. dental insurance operations, providing comprehensive plan creation, claim processing, and network handling for a seamless experience.
                    </p>
                    <a href="#" class="btn btn-outline-secondary btn-sm">Learn More About Dental Benefits</a>
                </div>
            </div>
        </div>
        
    </main>

    <footer class="bg-caredent-primary text-white pt-4 pb-2 mt-0">
        <div class="container text-center">
            <small>&copy; 2025 CareDent Insurance System. All rights reserved.</small>
        </div>
    </footer>

    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                
                <div class="modal-header bg-caredent-primary text-white">
                    <h5 class="modal-title" id="termsModalLabel"><i class="fas fa-file-contract me-2"></i> Dental Plan Terms & Conditions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <p>Please review the following standard terms and conditions before proceeding with your enrollment.</p>
                    
                    <div class="p-3 mb-3 border rounded" style="max-height: 300px; overflow-y: auto;">
                        <h6>**Standard Enrollment Agreement**</h6>
                        <p class="small">
                            By checking the box below, you ("The Member") agree to the terms set forth by CareDent Insurance Portal. 
                            This agreement covers eligibility, coverage details, payment responsibilities, and data privacy.
                            <br><br>
                            <strong>1. Eligibility:</strong> Coverage is effective upon the start date specified in your plan documents, provided the first premium payment is successfully processed. You certify that all information provided regarding yourself and any dependents is true and accurate.
                            <br><br>
                            <strong>2. Premiums and Payment:</strong> Premiums are due on the first day of each coverage month. Failure to pay premiums within the grace period may result in immediate cancellation of coverage.
                            <br><br>
                            <strong>3. Annual Maximums and Deductibles:</strong> Coverage is subject to the annual maximum and deductible amounts specified in your selected dental plan. All services are subject to review for medical necessity.
                            <br><br>
                            <strong>4. Data Privacy:</strong> You authorize CareDent to collect, use, and share your protected health information (PHI) with covered entities (providers, hospitals) as required for processing claims and administering the plan, in compliance with HIPAA guidelines.
                            <br><br>
                            <strong>5. Termination:</strong> You may terminate coverage at any time by providing written notice. CareDent reserves the right to terminate coverage for fraud, material misrepresentation, or non-payment of premiums.
                            <br><br>
                            <strong>6. Appeals:</strong> If a claim is denied, you have the right to appeal the decision following the procedures outlined in your Member Handbook.
                        </p>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="termsAcceptCheck">
                        <label class="form-check-label fw-bold" for="termsAcceptCheck">
                            I have read and agree to the Terms and Conditions listed above.
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <a th:href="@{/patient/dashboard}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i> Decline
                    </a>

                    <button type="button" id="acceptBtn" class="btn btn-secondary" disabled data-plan-id="">
                        <i class="fas fa-check me-1"></i> Accept & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 

    <script th:inline="javascript">
        $(document).ready(function() {
            const $checkbox = $('#termsAcceptCheck');
            const $acceptBtn = $('#acceptBtn');
            const $termsModal = $('#termsModal');
            
            // 1. When the modal is about to be shown (triggered by the plan button)
            $termsModal.on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget); // Button that triggered the modal
                const planId = button.data('plan-id'); // Extract the Plan ID from the button's data attribute
                
                // Store the selected Plan ID on the Accept button element
                $acceptBtn.data('plan-id', planId); 
                
                // Reset checkbox state when modal opens
                $checkbox.prop('checked', false).trigger('change');
            });

            // 2. Monitor the checkbox state to enable/disable the accept button
            $checkbox.on('change', function() {
                if ($(this).is(':checked')) {
                    // Checkbox Ticked: Enable the button and apply the green accent color
                    $acceptBtn.prop('disabled', false)
                              .removeClass('btn-secondary')
                              .addClass('btn-caredent-accent');
                } else {
                    // Checkbox Unticked: Disable the button and revert to secondary color
                    $acceptBtn.prop('disabled', true)
                              .removeClass('btn-caredent-accent')
                              .addClass('btn-secondary');
                }
            });

            // 3. Handle the Accept button click (Redirect to the enrollment form with the stored ID)
            $acceptBtn.on('click', function() {
                const planId = $(this).data('plan-id');
                
                if (planId && !$(this).prop('disabled')) {
                    // Use Thymeleaf inline mode to get the correct path structure
                    // The 'th:with' is a placeholder hack to force Thymeleaf to process the URL pattern
                    const ENROLLMENT_URL_PATTERN = /*[ th:with="id='__ID_PLACEHOLDER__'" ]*/ '/patient/enrollForm/__ID_PLACEHOLDER__';
                    
                    // Replace the placeholder with the actual planId
                    const redirectUrl = ENROLLMENT_URL_PATTERN.replace('__ID_PLACEHOLDER__', planId);
                    
                    $('#termsModal').modal('hide');
                    window.location.href = redirectUrl;
                }
            });
        });
    </script>
</body>
</html>